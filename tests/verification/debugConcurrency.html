<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¶å‘æ¨¡å—è°ƒè¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #f0f0f0;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 3px;
            height: 500px;
            overflow-y: auto;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¹¶å‘æ¨¡å—è°ƒè¯•å·¥å…·</h1>
        
        <button class="button" onclick="debugStep1()">1. æ£€æŸ¥æ–‡ä»¶è·¯å¾„</button>
        <button class="button" onclick="debugStep2()">2. æ‰‹åŠ¨åŠ è½½è„šæœ¬</button>
        <button class="button" onclick="debugStep3()">3. åˆ›å»ºå®ä¾‹</button>
        <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        
        <div id="errorDisplay" class="error" style="display: none;"></div>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            log(`âŒ ERROR: ${message}`);
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
            document.getElementById('errorDisplay').style.display = 'none';
        }
        
        function debugStep1() {
            log('ğŸ” æ­¥éª¤1: æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œç½‘ç»œè¯·æ±‚...');
            
            const scriptPath = '../../js/core/globalConcurrencyManager.js';
            
            fetch(scriptPath)
                .then(response => {
                    if (response.ok) {
                        log(`âœ… æ–‡ä»¶è·¯å¾„æ­£ç¡®: ${scriptPath}`);
                        log(`ğŸ“Š æ–‡ä»¶å¤§å°: ${response.headers.get('content-length')} bytes`);
                        return response.text();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(content => {
                    log(`ğŸ“„ æ–‡ä»¶å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
                    log(`ğŸ” æ£€æŸ¥å…³é”®ç±»å®šä¹‰...`);
                    
                    if (content.includes('class GlobalConcurrencyManager')) {
                        log('âœ… æ‰¾åˆ° GlobalConcurrencyManager ç±»å®šä¹‰');
                    } else {
                        log('âŒ æœªæ‰¾åˆ° GlobalConcurrencyManager ç±»å®šä¹‰');
                    }
                    
                    if (content.includes('new GlobalConcurrencyManager()')) {
                        log('âœ… æ‰¾åˆ°å®ä¾‹åˆ›å»ºä»£ç ');
                    } else {
                        log('âŒ æœªæ‰¾åˆ°å®ä¾‹åˆ›å»ºä»£ç ');
                    }
                    
                    if (content.includes('window.globalConcurrencyManager')) {
                        log('âœ… æ‰¾åˆ°å…¨å±€æš´éœ²ä»£ç ');
                    } else {
                        log('âŒ æœªæ‰¾åˆ°å…¨å±€æš´éœ²ä»£ç ');
                    }
                })
                .catch(error => {
                    showError(`æ–‡ä»¶åŠ è½½å¤±è´¥: ${error.message}`);
                });
        }
        
        function debugStep2() {
            log('ğŸ”§ æ­¥éª¤2: æ‰‹åŠ¨åŠ è½½è„šæœ¬...');
            
            // ç§»é™¤å·²å­˜åœ¨çš„è„šæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
            const existingScript = document.querySelector('script[src*="globalConcurrencyManager"]');
            if (existingScript) {
                existingScript.remove();
                log('ğŸ—‘ï¸ ç§»é™¤å·²å­˜åœ¨çš„è„šæœ¬æ ‡ç­¾');
            }
            
            // åˆ›å»ºæ–°çš„è„šæœ¬æ ‡ç­¾
            const script = document.createElement('script');
            script.src = '../../js/core/globalConcurrencyManager.js';
            
            script.onload = function() {
                log('âœ… è„šæœ¬åŠ è½½æˆåŠŸ');
                
                // ç«‹å³æ£€æŸ¥å…¨å±€å¯¹è±¡
                setTimeout(() => {
                    if (typeof window.globalConcurrencyManager !== 'undefined') {
                        log('âœ… globalConcurrencyManager å·²åœ¨å…¨å±€ä½œç”¨åŸŸä¸­');
                        const manager = window.globalConcurrencyManager;
                        log(`ğŸ“Š å®ä¾‹ç±»å‹: ${typeof manager}`);
                        log(`ğŸ“Š æœ€å¤§å¹¶å‘æ•°: ${manager.maxGlobalConcurrency}`);
                        log(`ğŸ“Š å½“å‰è¿è¡Œæ•°: ${manager.currentRunning}`);
                        
                        // æ£€æŸ¥å…³é”®æ–¹æ³•
                        const methods = ['acquireSlot', 'releaseSlot', 'getMetrics'];
                        methods.forEach(method => {
                            if (typeof manager[method] === 'function') {
                                log(`âœ… æ–¹æ³• ${method} å¯ç”¨`);
                            } else {
                                log(`âŒ æ–¹æ³• ${method} ä¸å¯ç”¨`);
                            }
                        });
                        
                    } else {
                        log('âŒ globalConcurrencyManager æœªåœ¨å…¨å±€ä½œç”¨åŸŸä¸­');
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å…¨å±€å˜é‡
                        log('ğŸ” æ£€æŸ¥å…¨å±€ä½œç”¨åŸŸä¸­çš„ç›¸å…³å¯¹è±¡...');
                        for (const key in window) {
                            if (key.toLowerCase().includes('concurrency') || key.toLowerCase().includes('manager')) {
                                log(`ğŸ” å‘ç°ç›¸å…³å¯¹è±¡: ${key} = ${typeof window[key]}`);
                            }
                        }
                    }
                }, 100);
            };
            
            script.onerror = function(event) {
                showError(`è„šæœ¬åŠ è½½é”™è¯¯: ${event.message || 'æœªçŸ¥é”™è¯¯'}`);
            };
            
            document.head.appendChild(script);
            log('ğŸ“¤ æ·»åŠ è„šæœ¬æ ‡ç­¾åˆ°é¡µé¢');
        }
        
        function debugStep3() {
            log('ğŸ—ï¸ æ­¥éª¤3: æ‰‹åŠ¨åˆ›å»ºå®ä¾‹...');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ„é€ å‡½æ•°
                if (typeof window.GlobalConcurrencyManager !== 'undefined') {
                    log('âœ… æ‰¾åˆ° GlobalConcurrencyManager æ„é€ å‡½æ•°');
                    
                    const manager = new window.GlobalConcurrencyManager(15);
                    window.globalConcurrencyManager = manager;
                    
                    log('âœ… æ‰‹åŠ¨åˆ›å»ºå®ä¾‹æˆåŠŸ');
                    log(`ğŸ“Š å®ä¾‹é…ç½®: maxGlobalConcurrency = ${manager.maxGlobalConcurrency}`);
                    
                    // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
                    manager.acquireSlot().then(slot => {
                        log(`âœ… æ§½ä½è·å–æµ‹è¯•æˆåŠŸ: ${slot.id}`);
                        manager.releaseSlot(slot, { success: true, latency: 100 });
                        log('âœ… æ§½ä½é‡Šæ”¾æµ‹è¯•æˆåŠŸ');
                    }).catch(error => {
                        log(`âŒ æ§½ä½æµ‹è¯•å¤±è´¥: ${error.message}`);
                    });
                    
                } else {
                    // å°è¯•ç›´æ¥å®šä¹‰ç±»
                    log('âš ï¸ æ„é€ å‡½æ•°ä¸å¯ç”¨ï¼Œå°è¯•ç›´æ¥å®šä¹‰...');
                    
                    window.eval(`
                        class GlobalConcurrencyManager {
                            constructor(maxGlobalConcurrency = 15) {
                                this.maxGlobalConcurrency = maxGlobalConcurrency;
                                this.currentRunning = 0;
                                this.waitingQueue = [];
                            }
                            
                            async acquireSlot() {
                                this.currentRunning++;
                                return {
                                    id: 'slot-' + Date.now(),
                                    acquireTime: Date.now(),
                                    releaseSlot: () => {
                                        this.currentRunning--;
                                    }
                                };
                            }
                            
                            releaseSlot(slot, result = {}) {
                                if (slot && typeof slot.releaseSlot === 'function') {
                                    slot.releaseSlot();
                                }
                            }
                            
                            getMetrics() {
                                return {
                                    totalRequests: 0,
                                    completedRequests: 0,
                                    currentRunning: this.currentRunning,
                                    maxGlobalConcurrency: this.maxGlobalConcurrency
                                };
                            }
                        }
                        
                        window.globalConcurrencyManager = new GlobalConcurrencyManager(15);
                    `);
                    
                    log('âœ… ç®€åŒ–ç‰ˆå®ä¾‹åˆ›å»ºæˆåŠŸ');
                }
                
            } catch (error) {
                showError(`å®ä¾‹åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }
        
        // ç›‘å¬å…¨å±€é”™è¯¯
        window.addEventListener('error', function(event) {
            showError(`JavaScripté”™è¯¯: ${event.message} (æ–‡ä»¶: ${event.filename}, è¡Œ: ${event.lineno})`);
        });
        
        // åˆå§‹åŒ–
        log('ğŸ”§ å¹¶å‘æ¨¡å—è°ƒè¯•å·¥å…·å·²åŠ è½½');
        log('ğŸ’¡ æŒ‰æ­¥éª¤ç‚¹å‡»æŒ‰é’®è¿›è¡Œè°ƒè¯•ï¼š');
        log('   1. æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
        log('   2. æ‰‹åŠ¨åŠ è½½è„šæœ¬');
        log('   3. åˆ›å»ºå®ä¾‹');
    </script>
</body>
</html>
