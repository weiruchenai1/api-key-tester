<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†é’¥éªŒè¯ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ å¯†é’¥éªŒè¯ä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. å…¨å±€å¹¶å‘ç®¡ç†å™¨çŠ¶æ€</h3>
            <button onclick="checkGlobalManager()">æ£€æŸ¥ç®¡ç†å™¨çŠ¶æ€</button>
            <div id="managerResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. å¹¶å‘é…ç½®æµ‹è¯•</h3>
            <button onclick="testConcurrencyConfig()">æµ‹è¯•å¹¶å‘é…ç½®</button>
            <div id="concurrencyResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. æ¨¡æ‹Ÿå¯†é’¥æµ‹è¯•</h3>
            <button onclick="simulateKeyTest()">æ¨¡æ‹Ÿæµ‹è¯•æµç¨‹</button>
            <div id="simulationResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. é‡ç½®å¹¶æ¸…ç†</h3>
            <button onclick="resetAndClean()">é‡ç½®ç®¡ç†å™¨</button>
            <div id="resetResult" class="result"></div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„æ¨¡å— -->
    <script src="../../js/core/globalConcurrencyManager.js"></script>
    <script src="../../js/core/concurrency.js"></script>
    
    <script>
        function checkGlobalManager() {
            const result = document.getElementById('managerResult');
            
            try {
                if (typeof globalConcurrencyManager === 'undefined') {
                    result.className = 'result error';
                    result.textContent = 'âŒ globalConcurrencyManager æœªæ‰¾åˆ°';
                    return;
                }
                
                const manager = globalConcurrencyManager;
                const metrics = manager.getMetrics ? manager.getMetrics() : {};
                
                const status = `âœ… å…¨å±€å¹¶å‘ç®¡ç†å™¨çŠ¶æ€:
ğŸ“Š æœ€å¤§å¹¶å‘æ•°: ${manager.maxGlobalConcurrency}
ğŸ”„ å½“å‰è¿è¡Œ: ${manager.currentRunning}
ğŸ¯ è‡ªé€‚åº”å¯ç”¨: ${manager.adaptiveConfig?.enabled || false}
ğŸ“ˆ æ€»è¯·æ±‚æ•°: ${metrics.totalRequests || 0}
âœ… å®Œæˆè¯·æ±‚: ${metrics.completedRequests || 0}
âŒ é”™è¯¯è¯·æ±‚: ${metrics.errorRequests || 0}

ğŸ”§ é”™è¯¯é˜ˆå€¼è®¾ç½®:
- 429é”™è¯¯ç‡é˜ˆå€¼: ${(manager.monitoring?.error429Threshold || 0) * 100}%
- æ€»é”™è¯¯ç‡é˜ˆå€¼: ${(manager.monitoring?.totalErrorThreshold || 0) * 100}%`;
                
                result.className = 'result success';
                result.textContent = status;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
            }
        }
        
        function testConcurrencyConfig() {
            const result = document.getElementById('concurrencyResult');
            
            try {
                if (typeof globalConcurrencyManager === 'undefined') {
                    result.className = 'result error';
                    result.textContent = 'âŒ globalConcurrencyManager æœªæ‰¾åˆ°';
                    return;
                }
                
                const manager = globalConcurrencyManager;
                const oldConcurrency = manager.maxGlobalConcurrency;
                
                // æµ‹è¯•è®¾ç½®ä¸åŒçš„å¹¶å‘æ•°
                const testValues = [5, 15, 30, 50];
                let testResults = 'ğŸ§ª å¹¶å‘é…ç½®æµ‹è¯•ç»“æœ:\n\n';
                
                for (const value of testValues) {
                    manager.maxGlobalConcurrency = value;
                    const actual = manager.maxGlobalConcurrency;
                    const success = actual === value;
                    testResults += `${success ? 'âœ…' : 'âŒ'} è®¾ç½® ${value} â†’ å®é™… ${actual}\n`;
                }
                
                // æ¢å¤åŸå€¼
                manager.maxGlobalConcurrency = oldConcurrency;
                testResults += `\nğŸ”„ å·²æ¢å¤åˆ°åŸå€¼: ${oldConcurrency}`;
                
                result.className = 'result success';
                result.textContent = testResults;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        async function simulateKeyTest() {
            const result = document.getElementById('simulationResult');
            result.className = 'result info';
            result.textContent = 'ğŸ”„ æ­£åœ¨æ¨¡æ‹Ÿå¯†é’¥æµ‹è¯•...';
            
            try {
                if (typeof globalConcurrencyManager === 'undefined') {
                    result.className = 'result error';
                    result.textContent = 'âŒ globalConcurrencyManager æœªæ‰¾åˆ°';
                    return;
                }
                
                const manager = globalConcurrencyManager;
                let simulationResults = 'ğŸ­ æ¨¡æ‹Ÿå¯†é’¥æµ‹è¯•ç»“æœ:\n\n';
                
                // æ¨¡æ‹Ÿè·å–5ä¸ªæ§½ä½
                const slots = [];
                for (let i = 0; i < 5; i++) {
                    try {
                        const slot = await manager.acquireSlot();
                        slots.push(slot);
                        simulationResults += `âœ… æ§½ä½ ${i+1}: ${slot.id}\n`;
                    } catch (error) {
                        simulationResults += `âŒ æ§½ä½ ${i+1}: è·å–å¤±è´¥ - ${error.message}\n`;
                    }
                }
                
                simulationResults += `\nğŸ“Š å½“å‰çŠ¶æ€: ${manager.currentRunning}/${manager.maxGlobalConcurrency}\n\n`;
                
                // æ¨¡æ‹Ÿä¸åŒçš„ç»“æœå¹¶é‡Šæ”¾æ§½ä½
                for (let i = 0; i < slots.length; i++) {
                    const slot = slots[i];
                    const isSuccess = Math.random() > 0.3; // 70% æˆåŠŸç‡
                    const latency = 1000 + Math.random() * 3000;
                    
                    manager.releaseSlot(slot, {
                        success: isSuccess,
                        latency: Math.round(latency),
                        status: isSuccess ? 200 : (Math.random() > 0.5 ? 403 : 429)
                    });
                    
                    simulationResults += `ğŸ”„ é‡Šæ”¾æ§½ä½ ${i+1}: ${isSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'} (${Math.round(latency)}ms)\n`;
                }
                
                const finalMetrics = manager.getMetrics ? manager.getMetrics() : {};
                simulationResults += `\nğŸ“ˆ æœ€ç»ˆæŒ‡æ ‡:
- æ€»è¯·æ±‚: ${finalMetrics.totalRequests}
- å®Œæˆè¯·æ±‚: ${finalMetrics.completedRequests}
- é”™è¯¯è¯·æ±‚: ${finalMetrics.errorRequests}
- å½“å‰å¹¶å‘: ${finalMetrics.currentRunning}`;
                
                result.className = 'result success';
                result.textContent = simulationResults;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`;
            }
        }
        
        function resetAndClean() {
            const result = document.getElementById('resetResult');
            
            try {
                if (typeof globalConcurrencyManager === 'undefined') {
                    result.className = 'result error';
                    result.textContent = 'âŒ globalConcurrencyManager æœªæ‰¾åˆ°';
                    return;
                }
                
                const manager = globalConcurrencyManager;
                const oldMetrics = manager.getMetrics ? manager.getMetrics() : {};
                
                // é‡ç½®ç»Ÿè®¡æ•°æ®
                if (typeof manager.resetStats === 'function') {
                    manager.resetStats();
                }
                
                const newMetrics = manager.getMetrics ? manager.getMetrics() : {};
                
                const resetResults = `ğŸ§¹ é‡ç½®æ“ä½œå®Œæˆ:

é‡ç½®å‰:
- æ€»è¯·æ±‚: ${oldMetrics.totalRequests || 0}
- å®Œæˆè¯·æ±‚: ${oldMetrics.completedRequests || 0}
- é”™è¯¯è¯·æ±‚: ${oldMetrics.errorRequests || 0}

é‡ç½®å:
- æ€»è¯·æ±‚: ${newMetrics.totalRequests || 0}
- å®Œæˆè¯·æ±‚: ${newMetrics.completedRequests || 0}
- é”™è¯¯è¯·æ±‚: ${newMetrics.errorRequests || 0}

âœ… å¹¶å‘ç®¡ç†å™¨å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•`;
                
                result.className = 'result success';
                result.textContent = resetResults;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ é‡ç½®å¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(checkGlobalManager, 500);
        });
    </script>
</body>
</html>
