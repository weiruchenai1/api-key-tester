<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•å¹¶å‘æ£€æŸ¥</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        
        .button:hover { background: #45a049; }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .result-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç®€å•å¹¶å‘æ£€æŸ¥å·¥å…·</h1>
        <p>å¿«é€Ÿæ£€æŸ¥æ­£å¼ç¨‹åºæ˜¯å¦åº”ç”¨äº†å¹¶å‘æ§åˆ¶</p>
        
        <div class="controls">
            <button class="button" onclick="checkMainProgram()">ğŸ” æ£€æŸ¥ä¸»ç¨‹åº</button>
            <button class="button" onclick="testConcurrency()">ğŸš€ æµ‹è¯•å¹¶å‘</button>
            <button class="button" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div id="statusDisplay" class="status hidden"></div>
        
        <div id="results" class="results hidden">
            <div class="result-card">
                <div id="moduleStatus" class="result-value">-</div>
                <div class="result-label">æ¨¡å—çŠ¶æ€</div>
            </div>
            <div class="result-card">
                <div id="concurrencyConfig" class="result-value">-</div>
                <div class="result-label">å¹¶å‘é…ç½®</div>
            </div>
            <div class="result-card">
                <div id="currentRunning" class="result-value">-</div>
                <div class="result-label">å½“å‰è¿è¡Œ</div>
            </div>
        </div>
        
        <div id="testLog" class="log"></div>
    </div>

    <!-- åŠ è½½ä¸»ç¨‹åºæ ¸å¿ƒæ¨¡å—è¿›è¡Œæ£€æŸ¥ -->
    <script src="../../js/core/globalConcurrencyManager.js"></script>
    <script src="../../js/core/concurrency.js"></script>
    
    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        function showStatus(message, level = 'success') {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.className = `status ${level}`;
            statusDisplay.textContent = message;
            statusDisplay.classList.remove('hidden');
        }
        
        function updateResults(moduleOk, concurrency, running) {
            document.getElementById('moduleStatus').textContent = moduleOk ? 'âœ…' : 'âŒ';
            document.getElementById('concurrencyConfig').textContent = concurrency || 'æœªé…ç½®';
            document.getElementById('currentRunning').textContent = running || '0';
            document.getElementById('results').classList.remove('hidden');
        }
        
        function checkMainProgram() {
            log('ğŸ” å¼€å§‹æ£€æŸ¥ä¸»ç¨‹åºå¹¶å‘çŠ¶æ€...');
            
            // æ£€æŸ¥å…³é”®æ¨¡å—
            const hasGlobalManager = typeof window.globalConcurrencyManager !== 'undefined';
            const hasProcessFunction = typeof window.processWithFixedConcurrency === 'function';
            const hasStartKeyTest = typeof window.startKeyTest === 'function';
            
            log(`ğŸ“‹ globalConcurrencyManager: ${hasGlobalManager ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
            log(`ğŸ“‹ processWithFixedConcurrency: ${hasProcessFunction ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
            log(`ğŸ“‹ startKeyTest: ${hasStartKeyTest ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
            
            let concurrencyConfig = 'æœªé…ç½®';
            let currentRunning = '0';
            
            if (hasGlobalManager) {
                const manager = window.globalConcurrencyManager;
                concurrencyConfig = manager.maxGlobalConcurrency || 'æœªè®¾ç½®';
                currentRunning = manager.currentRunning || '0';
                
                log(`ğŸ“Š æœ€å¤§å¹¶å‘æ•°: ${concurrencyConfig}`);
                log(`ğŸ”„ å½“å‰è¿è¡Œæ•°: ${currentRunning}`);
                log(`ğŸ§  è‡ªé€‚åº”ç­–ç•¥: ${manager.adaptiveConfig?.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                
                // è·å–è¯¦ç»†æŒ‡æ ‡
                if (manager.getMetrics) {
                    const metrics = manager.getMetrics();
                    log(`ğŸ“ˆ æ€»è¯·æ±‚æ•°: ${metrics.totalRequests || 0}`);
                    log(`âœ… å®Œæˆè¯·æ±‚æ•°: ${metrics.completedRequests || 0}`);
                    log(`ğŸ“Š å³°å€¼å¹¶å‘: ${metrics.peakConcurrency || 0}`);
                }
            }
            
            // ç»¼åˆè¯„åˆ¤
            const moduleOk = hasGlobalManager && hasProcessFunction;
            const isConfigured = concurrencyConfig > 5;
            
            if (moduleOk && isConfigured) {
                showStatus('âœ… å¹¶å‘æ§åˆ¶å·²æ­£ç¡®é…ç½®å¹¶åŠ è½½', 'success');
                log('âœ… æ£€æŸ¥é€šè¿‡ï¼šå¹¶å‘æ§åˆ¶å·²åº”ç”¨');
            } else if (moduleOk) {
                showStatus('âš ï¸ æ¨¡å—å·²åŠ è½½ä½†é…ç½®å¯èƒ½æœ‰é—®é¢˜', 'warning');
                log('âš ï¸ æ£€æŸ¥è­¦å‘Šï¼šæ¨¡å—å·²åŠ è½½ä½†é…ç½®éœ€è¦éªŒè¯');
            } else {
                showStatus('âŒ å¹¶å‘æ§åˆ¶æ¨¡å—æœªæ­£ç¡®åŠ è½½', 'error');
                log('âŒ æ£€æŸ¥å¤±è´¥ï¼šå…³é”®æ¨¡å—ç¼ºå¤±');
            }
            
            updateResults(moduleOk, concurrencyConfig, currentRunning);
        }
        
        async function testConcurrency() {
            log('ğŸš€ å¼€å§‹å¹¶å‘æµ‹è¯•...');
            
            if (typeof window.globalConcurrencyManager === 'undefined') {
                log('âŒ å…¨å±€å¹¶å‘ç®¡ç†å™¨ä¸å¯ç”¨ï¼Œæ— æ³•æµ‹è¯•');
                showStatus('âŒ æ— æ³•æµ‹è¯•ï¼šå¹¶å‘ç®¡ç†å™¨æœªåŠ è½½', 'error');
                return;
            }
            
            const manager = window.globalConcurrencyManager;
            const testCount = 10;
            
            log(`ğŸ¯ æµ‹è¯• ${testCount} ä¸ªå¹¶å‘ä»»åŠ¡...`);
            
            // ç›‘æ§å¹¶å‘çŠ¶æ€
            let maxObserved = 0;
            const startTime = Date.now();
            
            const monitor = setInterval(() => {
                const current = manager.currentRunning;
                maxObserved = Math.max(maxObserved, current);
                updateResults(true, manager.maxGlobalConcurrency, current);
                
                if (current > 0) {
                    log(`ğŸ“Š å½“å‰å¹¶å‘: ${current}`);
                }
            }, 200);
            
            // åˆ›å»ºæµ‹è¯•ä»»åŠ¡
            const tasks = [];
            for (let i = 0; i < testCount; i++) {
                tasks.push(testSingleTask(i));
            }
            
            try {
                await Promise.all(tasks);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                clearInterval(monitor);
                
                log(`âœ… æµ‹è¯•å®Œæˆï¼`);
                log(`â±ï¸ æ€»è€—æ—¶: ${duration}ms`);
                log(`ğŸ”¥ æœ€å¤§å¹¶å‘æ•°: ${maxObserved}`);
                log(`ğŸš€ ååé‡: ${(testCount / (duration / 1000)).toFixed(1)} tasks/sec`);
                
                if (maxObserved >= Math.min(manager.maxGlobalConcurrency, testCount)) {
                    showStatus('âœ… å¹¶å‘æµ‹è¯•é€šè¿‡ - è§‚å¯Ÿåˆ°é¢„æœŸçš„å¹¶å‘è¡Œä¸º', 'success');
                } else {
                    showStatus('âš ï¸ å¹¶å‘æµ‹è¯•è­¦å‘Š - å¹¶å‘æ•°ä½äºé¢„æœŸ', 'warning');
                }
                
            } catch (error) {
                clearInterval(monitor);
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                showStatus('âŒ å¹¶å‘æµ‹è¯•å¤±è´¥', 'error');
            }
        }
        
        async function testSingleTask(taskId) {
            const manager = window.globalConcurrencyManager;
            
            try {
                // è·å–æ§½ä½
                const slot = await manager.acquireSlot();
                log(`ğŸ“‹ ä»»åŠ¡ ${taskId}: è·å–æ§½ä½ ${slot.id}`);
                
                // æ¨¡æ‹Ÿå·¥ä½œ
                const workTime = 300 + Math.random() * 200; // 300-500ms
                await new Promise(resolve => setTimeout(resolve, workTime));
                
                // é‡Šæ”¾æ§½ä½
                manager.releaseSlot(slot, {
                    success: true,
                    latency: workTime
                });
                
                log(`âœ… ä»»åŠ¡ ${taskId}: å®Œæˆ (${workTime.toFixed(0)}ms)`);
                
            } catch (error) {
                log(`âŒ ä»»åŠ¡ ${taskId}: å¤±è´¥ - ${error.message}`);
                throw error;
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ§ª ç®€å•å¹¶å‘æ£€æŸ¥å·¥å…·å·²åŠ è½½');
            
            // å°è¯•åˆå§‹åŒ–å¹¶å‘ç®¡ç†å™¨ï¼ˆæ¨¡æ‹Ÿä¸»ç¨‹åºç¯å¢ƒï¼‰
            if (typeof window.globalConcurrencyManager !== 'undefined') {
                window.globalConcurrencyManager.maxGlobalConcurrency = 15;
                log('âš™ï¸ æ¨¡æ‹Ÿä¸»ç¨‹åºç¯å¢ƒï¼šè®¾ç½®å¹¶å‘æ•°ä¸º 15');
            }
            
            log('ğŸ’¡ ç‚¹å‡»"æ£€æŸ¥ä¸»ç¨‹åº"æŸ¥çœ‹æ¨¡å—çŠ¶æ€ï¼Œæˆ–"æµ‹è¯•å¹¶å‘"éªŒè¯å¹¶å‘è¡Œä¸º');
        });
    </script>
</body>
</html>
