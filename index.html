<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>API Key 测活工具</title>
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/mobile.css" />
    <style>
        /* 保留首屏极少量关键样式（如有） */
    </style>
</head>
<body>
    <!-- 主题切换控制按钮 -->
    <div class="theme-controls">
        <button class="control-btn" id="langBtn" title="切换语言">🌐</button>
        <button class="control-btn" id="themeBtn" title="切换主题">🌙</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 data-lang-key="title">🔑 API Key 测活工具</h1>
            <p data-lang-key="subtitle">批量检测 Gemini、Claude、GPT API 密钥有效性</p>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="input-group">
                    <label for="apiType" data-lang-key="select-api">选择 API 类型</label>
                    <select id="apiType" class="form-control">
                        <option value="openai">OpenAI GPT</option>
                        <option value="claude">Claude</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="modelInput" data-lang-key="select-model">测试模型</label>
                    <div class="model-input-group">
                        <select id="modelSelect" class="form-control">
                            <!-- 模型选项会根据API类型动态更新 -->
                        </select>
                        <input type="text" id="modelInput" class="form-control hidden" data-lang-key="model-input-placeholder" placeholder="输入自定义模型名">
                        <button type="button" class="model-toggle-btn" id="modelToggleBtn" data-lang-key="custom-model">自定义</button>
                    </div>
                    <small class="form-help" data-lang-key="model-help">可以选择预设模型或输入自定义模型名</small>
                </div>

                <div class="detected-models" id="detectedModels">
                    <div class="detected-models-header" id="detectedModelsHeader">
                        <h4 data-lang-key="detected-models-title">检测到的可用模型</h4>
                        <span class="collapse-icon collapsed" id="collapseIcon">▼</span>
                    </div>
                    <div class="model-list-container" id="modelListContainer">
                        <div class="model-list" id="modelList"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="proxyUrl" data-lang-key="proxy-url">代理服务器 URL (可选)</label>
                    <input type="text" id="proxyUrl" class="form-control" placeholder="https://your-proxy.com">
                    <small class="form-help" data-lang-key="proxy-help">留空使用默认代理，建议使用自己的反向代理以提高成功率</small>
                </div>

                <!-- 并发控制 -->
                <div class="input-group">
                    <label data-lang-key="concurrency-control">并发控制</label>
                    <div class="concurrency-container">
                                                  <div class="concurrency-input-section">
                             <input type="number" id="concurrencyInput" class="form-control" value="5" min="1">
                          </div>
                          <div class="slider-section">
                              <div class="slider-container">
                                 <input type="range" id="concurrencySlider" class="slider" min="1" max="50" value="5">
                                 <span class="slider-value" id="sliderValue">5</span>
                              </div>
                                                          <div class="preset-buttons">
                                  <button type="button" class="preset-btn" data-concurrency="1" data-lang-key="slow">慢速</button>
                                  <button type="button" class="preset-btn active" data-concurrency="5" data-lang-key="normal">正常</button>
                                  <button type="button" class="preset-btn" data-concurrency="10" data-lang-key="fast">快速</button>
                                  <button type="button" class="preset-btn" data-concurrency="20" data-lang-key="ultra">极速</button>
                              </div>
                        </div>
                    </div>
                </div>

                <!-- 重试控制 -->
                <div class="input-group">
                    <label data-lang-key="retry-control">重试控制</label>
                    <div class="retry-container">
                        <div class="retry-input-section">
                            <input type="number" id="retryInput" class="form-control" value="3" min="0" max="10">
                        </div>
                        <div class="retry-slider-section">
                            <div class="retry-slider-container">
                                <input type="range" id="retrySlider" class="retry-slider" min="0" max="10" value="3">
                                <span class="retry-slider-value" id="retrySliderValue">3</span>
                            </div>
                            <div class="retry-preset-buttons">
                                <button type="button" class="retry-preset-btn" data-retry="0" data-lang-key="no-retry">不重试</button>
                                <button type="button" class="retry-preset-btn" data-retry="2" data-lang-key="light-retry">轻度</button>
                                <button type="button" class="retry-preset-btn active" data-retry="3" data-lang-key="normal-retry">正常</button>
                                <button type="button" class="retry-preset-btn" data-retry="5" data-lang-key="heavy-retry">重度</button>
                            </div>
                        </div>
                    </div>
                    <small class="form-help" data-lang-key="retry-help">遇到临时错误(如403)时重试次数，有助于提高检测准确性</small>
                </div>
                
                <div class="input-group">
                    <div class="label-with-import">
                        <label for="apiKeys" data-lang-key="api-keys">API 密钥列表 (每行一个)</label>
                        <button class="import-btn" id="importBtn" title="导入文件">📁</button>
                    </div>
                    <div class="textarea-wrapper">
                        <textarea id="apiKeys" class="form-control textarea" data-lang-key="api-keys-placeholder" placeholder="请输入API密钥，每行一个：&#10;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#10;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#10;..."></textarea>
                        <button class="paste-btn" id="pasteBtn" title="粘贴">📋</button>
                    </div>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                </div>
                
                <div class="alert">
                    <strong data-lang-key="usage-title">💡 使用说明：</strong> 
                    <br><span data-lang-key="usage-1">• 强烈建议使用自定义代理URL，公共代理可能不稳定</span>
                    <br><span data-lang-key="usage-2">• Gemini代理示例: https://gemini.weiruchenai.me/v1beta</span>
<br><span data-lang-key="usage-3">• OpenAI代理示例: https://openai.weiruchenai.me/v1</span>
<br><span data-lang-key="usage-4">• Claude代理示例: https://claude.weiruchenai.me/v1</span>
                    <br><span data-lang-key="usage-5">• 直接访问官方API会因CORS限制失败</span>
                    <br><span data-lang-key="usage-6">• 测试过程中密钥仅用于验证，不会被存储</span>
                    <br><span data-lang-key="usage-7">• 智能重试机制可提高检测准确性，减少误判</span>
                    <br><span class="gemini-only hidden" data-lang-key="paid-detection-tip">• 付费检测将额外调用 cachedContents，可能消耗配额并耗时更长</span>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-detect" id="detectBtn" data-lang-key="detect-models">检测模型</button>
                    <button class="btn btn-primary" id="startBtn" data-lang-key="start-test">开始测试</button>
                    <button class="btn btn-secondary" id="dedupeBtn" data-lang-key="dedupe-keys">去重密钥</button>
                    <button class="btn btn-secondary" id="clearBtn" data-lang-key="clear">清空</button>
                </div>
            </div>
            
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="loading hidden" id="loading">
                <div class="spinner"></div>
                <p data-lang-key="testing">正在测试 API 密钥...</p>
            </div>
            
            <div class="results-section hidden" id="resultsSection">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number total" id="totalCount">0</div>
                        <div class="stat-label" data-lang-key="total">总计</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number valid" id="validCount">0</div>
                        <div class="stat-label" data-lang-key="valid">有效</div>
                    </div>
                    <div class="stat-card gemini-only hidden">
                        <div class="stat-number paid" id="paidCount">0</div>
                        <div class="stat-label" data-lang-key="paid">付费</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number invalid" id="invalidCount">0</div>
                        <div class="stat-label" data-lang-key="invalid">无效</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number rate-limited" id="rateLimitedCount">0</div>
                        <div class="stat-label" data-lang-key="rate-limited">速率限制</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number testing" id="testingCount">0</div>
                        <div class="stat-label" data-lang-key="testing-label">测试中</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number retrying" id="retryingCount">0</div>
                        <div class="stat-label" data-lang-key="retrying">重试中</div>
                    </div>
                </div>
                
                <div class="results-tabs">
                    <button class="tab active" data-tab="all" data-lang-key="all">全部</button>
                    <button class="tab" data-tab="valid" data-lang-key="valid-keys">有效密钥</button>
                    <button class="tab" data-tab="invalid" data-lang-key="invalid-keys">无效密钥</button>
                    <button class="tab" data-tab="rate-limited" data-lang-key="rate-limited-keys">速率限制</button>
                    <button class="tab gemini-only hidden" data-tab="paid" data-lang-key="paid-keys">付费密钥</button>
                </div>
                
                <div class="tab-content active" id="allTab">
                    <div class="key-list" id="allKeys"></div>
                    <button class="copy-btn" data-copy="all" data-lang-key="copy-all">复制全部</button>
                </div>
                
                <div class="tab-content" id="validTab">
                    <div class="key-list" id="validKeys"></div>
                    <button class="copy-btn" data-copy="valid" data-lang-key="copy-valid">复制有效密钥</button>
                </div>
                
                <div class="tab-content" id="invalidTab">
                    <div class="key-list" id="invalidKeys"></div>
                    <button class="copy-btn" data-copy="invalid" data-lang-key="copy-invalid">复制无效密钥</button>
                </div>
                
                <div class="tab-content" id="rateLimitedTab">
                    <div class="key-list" id="rateLimitedKeys"></div>
                    <button class="copy-btn" data-copy="rate-limited" data-lang-key="copy-rate-limited">复制速率限制密钥</button>
                </div>
                
                <div class="tab-content" id="paidTab">
                    <div class="key-list" id="paidKeys"></div>
                    <button class="copy-btn" data-copy="paid" data-lang-key="copy-paid">复制付费密钥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/services/apiUrl.js"></script>
    <script src="js/config/featureFlags.js"></script>
    <script src="js/core/retry.js"></script>
    <script src="js/core/concurrency.js"></script>
    <script src="js/core/tester.js"></script>
    <script src="js/config/modelOptions.js"></script>
    <script src="js/utils/keys.js"></script>
    <script src="js/utils/clipboard.js"></script>
    <script src="js/i18n/translations.js"></script>
    <script src="js/i18n/i18n.js"></script>
    <script src="js/ui/controls.js"></script>
    <script src="js/services/modelsService.js"></script>
    <script src="js/ui/results.js"></script>
    <script src="js/ui/models.js"></script>
    <script src="js/ui/theme.js"></script>
    <script src="js/ui/mobileEnhancements.js"></script>
    <script src="js/app/bootstrap.js"></script>
    <script src="js/services/openaiService.js"></script>
    <script src="js/services/claudeService.js"></script>
    <script src="js/services/geminiService.js"></script>
    <script src="js/services/geminiPaidService.js"></script>
    <script src="js/services/router.js"></script>
    
    <!-- 性能优化模块 -->
    <script src="js/ui/virtualList.js"></script>
    <script src="js/ui/performanceOptimized.js"></script>
    <script src="js/core/memoryManager.js"></script>
    <script src="js/core/progressiveLoader.js"></script>
    <script src="js/core/globalConcurrencyManager.js"></script>
    
    <!-- 高性能优化模块 -->
    <script src="js/core/adaptiveConcurrencyManager.js"></script>
    <script src="js/core/smartRetryManager.js"></script>
    <script src="js/core/enhancedMemoryManager.js"></script>
    <script src="js/core/highPerformanceProcessor.js"></script>
    <script src="js/core/networkOptimizer.js"></script>
    <script src="js/core/highSpeedController.js"></script>
    
    <script>
        // 全局变量
        let allKeysData = [];
        let currentLang = 'zh';
        let isDarkTheme = false;
        let isCustomModel = false;
        let detectedModels = new Set();
                  let currentConcurrency = 5;
        
        // 初始化高速检测控制器
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟初始化，确保所有脚本都已加载
            setTimeout(async function() {
                try {
                    console.log('[Init] 🚀 启动高速检测系统...');
                    
                    // 初始化高速控制器
                    if (typeof highSpeedController !== 'undefined') {
                        await highSpeedController.initialize();
                        console.log('[Init] ✅ 高速检测控制器已启用');
                        
                        // 添加状态更新回调
                        highSpeedController.onStatusUpdate((status) => {
                            // 更新进度显示
                            updateProgressDisplay(status);
                        });
                        
                        // 替换原始的开始测试函数
                        if (typeof window.startTest === 'function') {
                            window.originalStartTest = window.startTest;
                        }
                        window.startTest = async function() {
                            const keys = getApiKeysFromInput();
                            const apiType = document.getElementById('apiType').value;
                            
                            if (!keys || keys.length === 0) {
                                alert('请输入API密钥');
                                return;
                            }
                            
                            // 显示加载状态
                            showLoadingState();
                            
                            try {
                                console.log(`[HighSpeed] 开始高速检测: ${keys.length} 个密钥`);
                                const results = await highSpeedController.detectKeysAtHighSpeed(keys, apiType);
                                
                                // 显示完成状态
                                showCompletionState(results);
                                
                            } catch (error) {
                                console.error('[HighSpeed] 检测失败:', error);
                                alert('检测失败: ' + error.message);
                                
                                // 回退到传统模式
                                if (typeof window.originalStartTest === 'function') {
                                    console.log('[HighSpeed] 回退到传统检测模式');
                                    await window.originalStartTest();
                                }
                            } finally {
                                hideLoadingState();
                            }
                        };
                        
                    } else {
                        console.warn('[Init] 高速检测控制器未加载，使用传统模式');
                        initializeFallbackMode();
                    }
                    
                    // 兼容性：保持原有的并发管理器
                    if (typeof globalConcurrencyManager !== 'undefined') {
                        globalConcurrencyManager.maxGlobalConcurrency = 10; // 提高默认并发数
                        console.log('[Init] 传统并发管理器已配置');
                    }
                    
                } catch (error) {
                    console.error('[Init] 初始化失败:', error);
                    initializeFallbackMode();
                }
            }, 200); // 延迟200ms确保所有脚本加载完成
        });
        
        // 获取API密钥输入
        function getApiKeysFromInput() {
            const textarea = document.getElementById('apiKeys');
            if (!textarea) return [];
            
            return textarea.value
                .split('\n')
                .map(key => key.trim())
                .filter(key => key.length > 0);
        }
        
        // 显示加载状态
        function showLoadingState() {
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progressBar');
            const resultsSection = document.getElementById('resultsSection');
            
            if (loading) loading.classList.remove('hidden');
            if (progressBar) progressBar.classList.remove('hidden');
            if (resultsSection) resultsSection.classList.remove('hidden');
            
            isTestingInProgress = true;
        }
        
        // 隐藏加载状态
        function hideLoadingState() {
            const loading = document.getElementById('loading');
            if (loading) loading.classList.add('hidden');
            
            isTestingInProgress = false;
        }
        
        // 显示完成状态
        function showCompletionState(results) {
            console.log('[UI] 显示检测结果');
            
            // 更新统计显示
            updateFinalStats();
            
            // 显示完成消息
            showCompletionMessage();
        }
        
        // 更新进度显示
        function updateProgressDisplay(status) {
            // 更新进度条
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${status.progress}%`;
            }
            
            // 更新统计计数
            const testingElement = document.getElementById('testingCount');
            if (testingElement) {
                testingElement.textContent = (status.total - status.processed).toString();
            }
        }
        
        // 更新最终统计
        function updateFinalStats() {
            if (typeof allKeysData === 'undefined') return;
            
            const stats = {
                total: allKeysData.length,
                valid: allKeysData.filter(k => k.status === 'valid').length,
                invalid: allKeysData.filter(k => k.status === 'invalid').length,
                rateLimited: allKeysData.filter(k => k.status === 'rate-limited').length,
                paid: allKeysData.filter(k => k.status === 'paid').length
            };
            
            // 更新DOM元素
            const elements = {
                totalCount: stats.total,
                validCount: stats.valid,
                invalidCount: stats.invalid,
                rateLimitedCount: stats.rateLimited,
                paidCount: stats.paid,
                testingCount: 0
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value.toString();
                }
            });
        }
        
        // 后备模式初始化
        function initializeFallbackMode() {
            console.log('[Init] 启用后备模式');
            
            // 创建简化的并发管理器
            if (typeof globalConcurrencyManager === 'undefined') {
                window.globalConcurrencyManager = {
                    maxGlobalConcurrency: 10,
                    currentRunning: 0,
                    async acquireSlot() {
                        return { id: Date.now(), acquireTime: Date.now() };
                    },
                    releaseSlot() {},
                    getMetrics() {
                        return { currentRunning: 0, maxGlobalConcurrency: 10 };
                    }
                };
            }
            
            // 确保基本功能可用
            if (typeof window.startTest === 'undefined') {
                console.warn('[Init] startTest函数未定义，可能需要检查其他脚本加载');
            }
        }
        let currentRetryCount = 3;
        let isTestingInProgress = false;
        let shouldCancelTesting = false;
        let completedCount = 0;
        let totalCount = 0;
        let updateTimer = null;

        // 显示完成消息
        function showCompletionMessage() {
            const validCount = allKeysData.filter(k => k.status === 'valid').length;
            const invalidCount = allKeysData.filter(k => k.status === 'invalid').length;
            const rateLimitedCount = allKeysData.filter(k => k.status === 'rate-limited').length;
            const paidCount = allKeysData.filter(k => k.status === 'paid').length;
            
            // 检查是否是Gemini类型的测试
            const apiType = document.getElementById('apiType')?.value;
            const isGemini = apiType === 'gemini';
            
            let message;
            if (currentLang === 'zh') {
                message = `测试完成！有效密钥: ${validCount}，无效密钥: ${invalidCount}，速率限制: ${rateLimitedCount}`;
                if (isGemini) {
                    message += `，付费密钥: ${paidCount}`;
                }
            } else {
                message = `Test completed! Valid keys: ${validCount}, Invalid keys: ${invalidCount}, Rate limited: ${rateLimitedCount}`;
                if (isGemini) {
                    message += `, Paid keys: ${paidCount}`;
                }
            }
            alert(message);
        }

        // 页面卸载时清理资源
        function cleanupResources() {
            console.log('[Cleanup] 开始清理页面资源...');
            
            try {
                // 清理UI模块的定时器
                if (typeof cleanupUITimers === 'function') {
                    cleanupUITimers();
                }
                
                // 清理性能优化模块
                if (typeof cleanupPerformanceOptimization === 'function') {
                    cleanupPerformanceOptimization();
                }
                
                // 清理主定时器
                if (typeof updateTimer !== 'undefined' && updateTimer) {
                    clearTimeout(updateTimer);
                    updateTimer = null;
                }
                
                // 清理虚拟列表（如果性能优化模块没有处理）
                if (typeof virtualLists !== 'undefined') {
                    Object.values(virtualLists).forEach(list => {
                        if (list && typeof list.destroy === 'function') {
                            list.destroy();
                        }
                    });
                }
                
                // 清理全局状态
                allKeysData = [];
                if (typeof detectedModels !== 'undefined') {
                    detectedModels.clear();
                }
                
                // 重置测试状态
                isTestingInProgress = false;
                shouldCancelTesting = false;
                completedCount = 0;
                totalCount = 0;
                
                console.log('[Cleanup] 资源清理完成');
            } catch (error) {
                console.error('[Cleanup] 资源清理时出错:', error);
            }
        }

        // 监听页面卸载事件
        window.addEventListener('beforeunload', cleanupResources);
        window.addEventListener('unload', cleanupResources);

    </script>
</body>
</html>