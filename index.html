<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>API Key æµ‹æ´»å·¥å…·</title>
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/theme.css" />
    <style>
        /* ä¿ç•™é¦–å±æå°‘é‡å…³é”®æ ·å¼ï¼ˆå¦‚æœ‰ï¼‰ */
    </style>
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æ§åˆ¶æŒ‰é’® -->
    <div class="theme-controls">
        <button class="control-btn" id="langBtn" title="åˆ‡æ¢è¯­è¨€">ğŸŒ</button>
        <button class="control-btn" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 data-lang-key="title">ğŸ”‘ API Key æµ‹æ´»å·¥å…·</h1>
            <p data-lang-key="subtitle">æ‰¹é‡æ£€æµ‹ Geminiã€Claudeã€GPT API å¯†é’¥æœ‰æ•ˆæ€§</p>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="input-group">
                    <label for="apiType" data-lang-key="select-api">é€‰æ‹© API ç±»å‹</label>
                    <select id="apiType" class="form-control">
                        <option value="openai">OpenAI GPT</option>
                        <option value="claude">Claude</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="modelInput" data-lang-key="select-model">æµ‹è¯•æ¨¡å‹</label>
                    <div class="model-input-group">
                        <select id="modelSelect" class="form-control">
                            <!-- æ¨¡å‹é€‰é¡¹ä¼šæ ¹æ®APIç±»å‹åŠ¨æ€æ›´æ–° -->
                        </select>
                        <input type="text" id="modelInput" class="form-control hidden" data-lang-key="model-input-placeholder" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹å">
                        <button type="button" class="model-toggle-btn" id="modelToggleBtn" data-lang-key="custom-model">è‡ªå®šä¹‰</button>
                    </div>
                    <small class="form-help" data-lang-key="model-help">å¯ä»¥é€‰æ‹©é¢„è®¾æ¨¡å‹æˆ–è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹å</small>
                </div>

                <div class="detected-models" id="detectedModels">
                    <div class="detected-models-header" id="detectedModelsHeader">
                        <h4 data-lang-key="detected-models-title">æ£€æµ‹åˆ°çš„å¯ç”¨æ¨¡å‹</h4>
                        <span class="collapse-icon collapsed" id="collapseIcon">â–¼</span>
                    </div>
                    <div class="model-list-container" id="modelListContainer">
                        <div class="model-list" id="modelList"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="proxyUrl" data-lang-key="proxy-url">ä»£ç†æœåŠ¡å™¨ URL (å¯é€‰)</label>
                    <input type="text" id="proxyUrl" class="form-control" placeholder="https://your-proxy.com">
                    <small class="form-help" data-lang-key="proxy-help">ç•™ç©ºä½¿ç”¨é»˜è®¤ä»£ç†ï¼Œå»ºè®®ä½¿ç”¨è‡ªå·±çš„åå‘ä»£ç†ä»¥æé«˜æˆåŠŸç‡</small>
                </div>

                <!-- å¹¶å‘æ§åˆ¶ -->
                <div class="input-group">
                    <label data-lang-key="concurrency-control">å¹¶å‘æ§åˆ¶</label>
                    <div class="concurrency-container">
                                                  <div class="concurrency-input-section">
                             <input type="number" id="concurrencyInput" class="form-control" value="5" min="1">
                          </div>
                          <div class="slider-section">
                              <div class="slider-container">
                                 <input type="range" id="concurrencySlider" class="slider" min="1" max="50" value="5">
                                 <span class="slider-value" id="sliderValue">5</span>
                              </div>
                                                          <div class="preset-buttons">
                                  <button type="button" class="preset-btn" data-concurrency="1" data-lang-key="slow">æ…¢é€Ÿ</button>
                                  <button type="button" class="preset-btn active" data-concurrency="5" data-lang-key="normal">æ­£å¸¸</button>
                                  <button type="button" class="preset-btn" data-concurrency="10" data-lang-key="fast">å¿«é€Ÿ</button>
                                  <button type="button" class="preset-btn" data-concurrency="20" data-lang-key="ultra">æé€Ÿ</button>
                              </div>
                        </div>
                    </div>
                </div>

                <!-- é‡è¯•æ§åˆ¶ -->
                <div class="input-group">
                    <label data-lang-key="retry-control">é‡è¯•æ§åˆ¶</label>
                    <div class="retry-container">
                        <div class="retry-input-section">
                            <input type="number" id="retryInput" class="form-control" value="3" min="0" max="10">
                        </div>
                        <div class="retry-slider-section">
                            <div class="retry-slider-container">
                                <input type="range" id="retrySlider" class="retry-slider" min="0" max="10" value="3">
                                <span class="retry-slider-value" id="retrySliderValue">3</span>
                            </div>
                            <div class="retry-preset-buttons">
                                <button type="button" class="retry-preset-btn" data-retry="0" data-lang-key="no-retry">ä¸é‡è¯•</button>
                                <button type="button" class="retry-preset-btn" data-retry="2" data-lang-key="light-retry">è½»åº¦</button>
                                <button type="button" class="retry-preset-btn active" data-retry="3" data-lang-key="normal-retry">æ­£å¸¸</button>
                                <button type="button" class="retry-preset-btn" data-retry="5" data-lang-key="heavy-retry">é‡åº¦</button>
                            </div>
                        </div>
                    </div>
                    <small class="form-help" data-lang-key="retry-help">é‡åˆ°ä¸´æ—¶é”™è¯¯(å¦‚403)æ—¶é‡è¯•æ¬¡æ•°ï¼Œæœ‰åŠ©äºæé«˜æ£€æµ‹å‡†ç¡®æ€§</small>
                </div>
                
                <div class="input-group">
                    <div class="label-with-import">
                        <label for="apiKeys" data-lang-key="api-keys">API å¯†é’¥åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª)</label>
                        <button class="import-btn" id="importBtn" title="å¯¼å…¥æ–‡ä»¶">ğŸ“</button>
                    </div>
                    <div class="textarea-wrapper">
                        <textarea id="apiKeys" class="form-control textarea" data-lang-key="api-keys-placeholder" placeholder="è¯·è¾“å…¥APIå¯†é’¥ï¼Œæ¯è¡Œä¸€ä¸ªï¼š&#10;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#10;sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#10;..."></textarea>
                        <button class="paste-btn" id="pasteBtn" title="ç²˜è´´">ğŸ“‹</button>
                    </div>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                </div>
                
                <div class="alert">
                    <strong data-lang-key="usage-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong> 
                    <br><span data-lang-key="usage-1">â€¢ å¼ºçƒˆå»ºè®®ä½¿ç”¨è‡ªå®šä¹‰ä»£ç†URLï¼Œå…¬å…±ä»£ç†å¯èƒ½ä¸ç¨³å®š</span>
                    <br><span data-lang-key="usage-2">â€¢ Geminiä»£ç†ç¤ºä¾‹: https://gemini.weiruchenai.me/v1beta</span>
<br><span data-lang-key="usage-3">â€¢ OpenAIä»£ç†ç¤ºä¾‹: https://openai.weiruchenai.me/v1</span>
<br><span data-lang-key="usage-4">â€¢ Claudeä»£ç†ç¤ºä¾‹: https://claude.weiruchenai.me/v1</span>
                    <br><span data-lang-key="usage-5">â€¢ ç›´æ¥è®¿é—®å®˜æ–¹APIä¼šå› CORSé™åˆ¶å¤±è´¥</span>
                    <br><span data-lang-key="usage-6">â€¢ æµ‹è¯•è¿‡ç¨‹ä¸­å¯†é’¥ä»…ç”¨äºéªŒè¯ï¼Œä¸ä¼šè¢«å­˜å‚¨</span>
                    <br><span data-lang-key="usage-7">â€¢ æ™ºèƒ½é‡è¯•æœºåˆ¶å¯æé«˜æ£€æµ‹å‡†ç¡®æ€§ï¼Œå‡å°‘è¯¯åˆ¤</span>
                    <br><span class="gemini-only hidden" data-lang-key="paid-detection-tip">â€¢ ä»˜è´¹æ£€æµ‹å°†é¢å¤–è°ƒç”¨ cachedContentsï¼Œå¯èƒ½æ¶ˆè€—é…é¢å¹¶è€—æ—¶æ›´é•¿</span>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-detect" id="detectBtn" data-lang-key="detect-models">æ£€æµ‹æ¨¡å‹</button>
                    <button class="btn btn-primary" id="startBtn" data-lang-key="start-test">å¼€å§‹æµ‹è¯•</button>
                    <button class="btn btn-secondary" id="dedupeBtn" data-lang-key="dedupe-keys">å»é‡å¯†é’¥</button>
                    <button class="btn btn-secondary" id="clearBtn" data-lang-key="clear">æ¸…ç©º</button>
                </div>
            </div>
            
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="loading hidden" id="loading">
                <div class="spinner"></div>
                <p data-lang-key="testing">æ­£åœ¨æµ‹è¯• API å¯†é’¥...</p>
            </div>
            
            <div class="results-section hidden" id="resultsSection">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number total" id="totalCount">0</div>
                        <div class="stat-label" data-lang-key="total">æ€»è®¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number valid" id="validCount">0</div>
                        <div class="stat-label" data-lang-key="valid">æœ‰æ•ˆ</div>
                    </div>
                    <div class="stat-card gemini-only hidden">
                        <div class="stat-number paid" id="paidCount">0</div>
                        <div class="stat-label" data-lang-key="paid">ä»˜è´¹</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number invalid" id="invalidCount">0</div>
                        <div class="stat-label" data-lang-key="invalid">æ— æ•ˆ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number rate-limited" id="rateLimitedCount">0</div>
                        <div class="stat-label" data-lang-key="rate-limited">é€Ÿç‡é™åˆ¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number testing" id="testingCount">0</div>
                        <div class="stat-label" data-lang-key="testing-label">æµ‹è¯•ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number retrying" id="retryingCount">0</div>
                        <div class="stat-label" data-lang-key="retrying">é‡è¯•ä¸­</div>
                    </div>
                </div>
                
                <div class="results-tabs">
                    <button class="tab active" data-tab="all" data-lang-key="all">å…¨éƒ¨</button>
                    <button class="tab" data-tab="valid" data-lang-key="valid-keys">æœ‰æ•ˆå¯†é’¥</button>
                    <button class="tab" data-tab="invalid" data-lang-key="invalid-keys">æ— æ•ˆå¯†é’¥</button>
                    <button class="tab" data-tab="rate-limited" data-lang-key="rate-limited-keys">é€Ÿç‡é™åˆ¶</button>
                    <button class="tab gemini-only hidden" data-tab="paid" data-lang-key="paid-keys">ä»˜è´¹å¯†é’¥</button>
                </div>
                
                <div class="tab-content active" id="allTab">
                    <div class="key-list" id="allKeys"></div>
                    <button class="copy-btn" data-copy="all" data-lang-key="copy-all">å¤åˆ¶å…¨éƒ¨</button>
                </div>
                
                <div class="tab-content" id="validTab">
                    <div class="key-list" id="validKeys"></div>
                    <button class="copy-btn" data-copy="valid" data-lang-key="copy-valid">å¤åˆ¶æœ‰æ•ˆå¯†é’¥</button>
                </div>
                
                <div class="tab-content" id="invalidTab">
                    <div class="key-list" id="invalidKeys"></div>
                    <button class="copy-btn" data-copy="invalid" data-lang-key="copy-invalid">å¤åˆ¶æ— æ•ˆå¯†é’¥</button>
                </div>
                
                <div class="tab-content" id="rateLimitedTab">
                    <div class="key-list" id="rateLimitedKeys"></div>
                    <button class="copy-btn" data-copy="rate-limited" data-lang-key="copy-rate-limited">å¤åˆ¶é€Ÿç‡é™åˆ¶å¯†é’¥</button>
                </div>
                
                <div class="tab-content" id="paidTab">
                    <div class="key-list" id="paidKeys"></div>
                    <button class="copy-btn" data-copy="paid" data-lang-key="copy-paid">å¤åˆ¶ä»˜è´¹å¯†é’¥</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/services/apiUrl.js"></script>
    <script src="js/config/featureFlags.js"></script>
    <script src="js/core/retry.js"></script>
    <script src="js/core/concurrency.js"></script>
    <script src="js/core/tester.js"></script>
    <script src="js/config/modelOptions.js"></script>
    <script src="js/utils/keys.js"></script>
    <script src="js/utils/clipboard.js"></script>
    <script src="js/i18n/translations.js"></script>
    <script src="js/i18n/i18n.js"></script>
    <script src="js/ui/controls.js"></script>
    <script src="js/services/modelsService.js"></script>
    <script src="js/ui/results.js"></script>
    <script src="js/ui/models.js"></script>
    <script src="js/ui/theme.js"></script>
    <script src="js/app/bootstrap.js"></script>
    <script src="js/services/openaiService.js"></script>
    <script src="js/services/claudeService.js"></script>
    <script src="js/services/geminiService.js"></script>
    <script src="js/services/geminiPaidService.js"></script>
    <script src="js/services/router.js"></script>
    
    <!-- æ€§èƒ½ä¼˜åŒ–æ¨¡å— -->
    <script src="js/ui/virtualList.js"></script>
    <script src="js/ui/performanceOptimized.js"></script>
    <script src="js/core/memoryManager.js"></script>
          <script src="js/core/progressiveLoader.js"></script>
      <script src="js/core/globalConcurrencyManager.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let allKeysData = [];
        let currentLang = 'zh';
        let isDarkTheme = false;
        let isCustomModel = false;
        let detectedModels = new Set();
                  let currentConcurrency = 5;
        
        // åˆå§‹åŒ–å…¨å±€å¹¶å‘ç®¡ç†å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½å·²åŠ è½½
            setTimeout(function() {
                if (typeof globalConcurrencyManager !== 'undefined') {
                    // é‡ç½®ç»Ÿè®¡æ•°æ®
                    if (typeof globalConcurrencyManager.resetStats === 'function') {
                        globalConcurrencyManager.resetStats();
                        console.log('[Init] ç»Ÿè®¡æ•°æ®å·²é‡ç½®');
                    }
                    
                    // è®¾ç½®åˆå§‹å¹¶å‘æ•°ä¸º5
                    globalConcurrencyManager.maxGlobalConcurrency = 5;
                    console.log(`[Init] å…¨å±€å¹¶å‘ç®¡ç†å™¨å·²å¯ç”¨ï¼Œåˆå§‹å¹¶å‘æ•°: ${globalConcurrencyManager.maxGlobalConcurrency}`);
                    console.log('[Init] ä½¿ç”¨å›ºå®šå¹¶å‘æ§åˆ¶æ¨¡å¼');
                    
                    // ç¡®ä¿UIæ§åˆ¶å™¨å·²åˆå§‹åŒ–å¹¶åŒæ­¥
                    if (typeof updateConcurrency === 'function') {
                        updateConcurrency(5); // åŒæ­¥UIæ˜¾ç¤ºå’Œå…¨å±€ç®¡ç†å™¨
                        console.log('[Init] UIå¹¶å‘æ§åˆ¶å·²åŒæ­¥');
                    }
                } else {
                    console.warn('[Init] å…¨å±€å¹¶å‘ç®¡ç†å™¨æœªåŠ è½½ï¼Œå°è¯•åˆ›å»ºç®€åŒ–ç‰ˆæœ¬...');
                    
                    // åˆ›å»ºç®€åŒ–çš„å¹¶å‘ç®¡ç†å™¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                    try {
                        window.globalConcurrencyManager = {
                            maxGlobalConcurrency: 5,
                            currentRunning: 0,
                            waitingQueue: [],
                            
                            async acquireSlot() {
                                this.currentRunning++;
                                const slot = {
                                    id: `slot-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                    acquireTime: Date.now(),
                                    releaseSlot: () => {
                                        this.currentRunning--;
                                    }
                                };
                                console.log(`[Fallback] è·å–æ§½ä½: ${slot.id}, å½“å‰å¹¶å‘: ${this.currentRunning}`);
                                return slot;
                            },
                            
                            releaseSlot(slot, result = {}) {
                                if (slot && typeof slot.releaseSlot === 'function') {
                                    slot.releaseSlot();
                                    console.log(`[Fallback] é‡Šæ”¾æ§½ä½: ${slot.id}, å½“å‰å¹¶å‘: ${this.currentRunning}`);
                                }
                            },
                            
                            getMetrics() {
                                return {
                                    totalRequests: 0,
                                    completedRequests: 0,
                                    currentRunning: this.currentRunning,
                                    maxGlobalConcurrency: this.maxGlobalConcurrency,
                                    peakConcurrency: this.currentRunning
                                };
                            }
                        };
                        
                        console.log('[Init] ç®€åŒ–ç‰ˆå¹¶å‘ç®¡ç†å™¨å·²åˆ›å»ºï¼Œå¹¶å‘æ•°: 5');
                        console.log('[Init] æ³¨æ„: ä½¿ç”¨çš„æ˜¯åå¤‡ç‰ˆæœ¬ï¼Œä»…æä¾›åŸºæœ¬å¹¶å‘æ§åˆ¶');
                        
                        // åŒæ­¥UIæ§åˆ¶å™¨
                        if (typeof updateConcurrency === 'function') {
                            updateConcurrency(5);
                            console.log('[Init] UIå¹¶å‘æ§åˆ¶å·²åŒæ­¥ï¼ˆåå¤‡ç‰ˆæœ¬ï¼‰');
                        }
                        
                    } catch (error) {
                        console.error('[Init] åˆ›å»ºåå¤‡å¹¶å‘ç®¡ç†å™¨å¤±è´¥:', error);
                        console.warn('[Init] å°†ä½¿ç”¨å›ºå®šå¹¶å‘æ•°:', currentConcurrency);
                    }
                }
            }, 100); // å»¶è¿Ÿ100msç¡®ä¿è„šæœ¬åŠ è½½å®Œæˆ
        });
        let currentRetryCount = 3;
        let isTestingInProgress = false;
        let shouldCancelTesting = false;
        let completedCount = 0;
        let totalCount = 0;
        let updateTimer = null;

        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        function showCompletionMessage() {
            const validCount = allKeysData.filter(k => k.status === 'valid').length;
            const invalidCount = allKeysData.filter(k => k.status === 'invalid').length;
            const rateLimitedCount = allKeysData.filter(k => k.status === 'rate-limited').length;
            const paidCount = allKeysData.filter(k => k.status === 'paid').length;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯Geminiç±»å‹çš„æµ‹è¯•
            const apiType = document.getElementById('apiType')?.value;
            const isGemini = apiType === 'gemini';
            
            let message;
            if (currentLang === 'zh') {
                message = `æµ‹è¯•å®Œæˆï¼æœ‰æ•ˆå¯†é’¥: ${validCount}ï¼Œæ— æ•ˆå¯†é’¥: ${invalidCount}ï¼Œé€Ÿç‡é™åˆ¶: ${rateLimitedCount}`;
                if (isGemini) {
                    message += `ï¼Œä»˜è´¹å¯†é’¥: ${paidCount}`;
                }
            } else {
                message = `Test completed! Valid keys: ${validCount}, Invalid keys: ${invalidCount}, Rate limited: ${rateLimitedCount}`;
                if (isGemini) {
                    message += `, Paid keys: ${paidCount}`;
                }
            }
            alert(message);
        }

    </script>
</body>
</html>