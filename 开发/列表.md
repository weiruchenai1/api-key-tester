# HTTP状态码判断列表

## 概述
本文档列出了API密钥测试系统中所有用于判断的HTTP状态码及其对应的原因和处理逻辑。

## 状态码分类

### 1. 成功状态码

| 状态码 | 含义 | 处理逻辑 | 最终状态 | 备注 |
|--------|------|----------|----------|------|
| 200 | OK | 检查响应内容格式 | valid | 需要验证响应数据结构 |

### 2. 客户端错误状态码 (4xx)

| 状态码 | 含义 | 处理逻辑 | 最终状态 | 是否重试 | 备注 |
|--------|------|----------|----------|----------|------|
| 400 | Bad Request | 直接标记为无效 | invalid | ❌ | 格式错误 |
| 401 | Unauthorized | 直接标记为无效 | invalid | ❌ | 认证失败|
| 403 | Forbidden | 标记为无效，但会重试 | invalid | ✅ | 权限不足 |
| 429 | Too Many Requests | 标记为速率限制 | rate-limited | ❌ | 速率限制 |

### 3. 服务器错误状态码 (5xx)

| 状态码 | 含义 | 处理逻辑 | 最终状态 | 是否重试 | 备注 |
|--------|------|----------|----------|----------|------|
| 502 | Bad Gateway | 标记为无效，会重试 | invalid | ✅ | 网关错误|
| 503 | Service Unavailable | 标记为无效，会重试 | invalid | ✅ | 服务不可用 |
| 504 | Gateway Timeout | 标记为无效，会重试 | invalid | ✅ | 网关超时 |

## 特殊处理逻辑

### Claude API特殊处理
| 状态码 | 错误类型 | 处理逻辑 | 最终状态 |
|--------|----------|----------|----------|
| 400 | authentication_error | 标记为无效 | invalid |
| 400 | rate_limit_error | 标记为速率限制 | rate-limited |
| 400 | invalid_request_error | **标记为有效** | valid |

### Gemini付费检测特殊处理
| 状态码 | Cache API响应 | 付费状态判断 | 备注 |
|--------|---------------|--------------|------|
| 200 | 成功创建缓存 | paid | 确认为付费账户 |
| 400 | 请求格式错误 | invalid | 密钥无效，不进行付费判断 |
| 401 | 认证失败 | invalid | 密钥无效，不进行付费判断 |
| 403 | 权限不足 | free | 密钥有效但无Cache API权限 |
| 429 | 速率限制 | free | 确认为免费账户 |
| 其他 | 未知错误 | unknown | 无法确定状态 |

## 重试机制状态码

### 会触发重试的状态码
```javascript
[403, 502, 503, 504]
```

### 重试逻辑
- **403**: 权限不足，可能是临时问题
- **502**: 网关错误，服务器临时问题
- **503**: 服务不可用，服务器临时问题  
- **504**: 网关超时，网络临时问题

### 不会重试的状态码
- **400**: 请求格式错误，重试无意义
- **401**: 认证失败，密钥问题
- **429**: 速率限制，重试会加重负担
- **其他4xx**: 客户端错误，重试无意义

## 错误消息关键词检测

### 速率限制关键词
无论HTTP状态码如何，如果错误消息包含以下关键词，都会被标记为速率限制：
- `rate limit` (不区分大小写)
- `too many requests`
- `quota exceeded`

### 网络错误关键词
以下关键词会触发重试机制：
- `timeout`
- `network`
- `连接`
- `fetch`

## API服务差异

### OpenAI
- 使用状态码: 401, 403, 429
- 特殊处理: 检查响应中的错误消息

### Claude  
- 使用状态码: 401, 403, 429, 400
- 特殊处理: 400状态码需要检查错误类型

### Gemini
- 使用状态码: 400, 401, 403, 429
- 特殊处理: 付费检测使用Cache API

### DeepSeek/SiliconCloud/XAI/OpenRouter
- 使用状态码: 401, 403, 429
- 处理逻辑: 基本的状态码检查

## 状态优先级

当同时满足多个条件时，按以下优先级确定最终状态：

1. **paid** (最高优先级) - Gemini付费检测成功
2. **valid** - API调用成功且响应格式正确
3. **rate-limited** - 遇到429状态码或速率限制关键词
4. **invalid** (默认) - 其他所有失败情况

## 代码位置

### 主要判断逻辑
- **Worker**: `public/worker.js` - 统一的状态判断和重试逻辑
- **API服务**: `src/services/api/*.js` - 各API的具体实现

### 重试机制
- **shouldRetry函数**: `public/worker.js:267-284`
- **重试状态码数组**: `[403, 502, 503, 504]`

### 状态码提取
- **extractStatusCode函数**: `public/worker.js:286-300`
- 从错误消息中提取HTTP状态码